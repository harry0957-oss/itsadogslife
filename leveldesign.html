<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Town Level Designer</title>
  <style>
    :root {
      color-scheme: dark;
      font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
      background-color: #0b1522;
      color: #f4f7fb;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 1.5rem;
      padding: 1.5rem;
      background: radial-gradient(circle at top, rgba(100, 160, 255, 0.18), rgba(11, 21, 34, 0.95));
    }

    header {
      grid-column: 1 / -1;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
    }

    h1 {
      margin: 0;
      font-size: clamp(1.6rem, 3vw, 2.3rem);
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .controls {
      background: rgba(9, 18, 29, 0.85);
      border: 1px solid rgba(255, 255, 255, 0.07);
      border-radius: 1.2rem;
      padding: 1.25rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      box-shadow: 0 1.5rem 3.5rem rgba(0, 0, 0, 0.35);
    }

    fieldset {
      border: none;
      padding: 0;
      margin: 0;
      display: grid;
      gap: 0.5rem;
    }

    legend {
      margin-bottom: 0.25rem;
      font-size: 0.95rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: #9ecbff;
    }

    .tool-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 0.5rem;
    }

    button.tool {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      justify-content: center;
      padding: 0.6rem 0.75rem;
      border-radius: 0.75rem;
      border: 1px solid rgba(158, 203, 255, 0.4);
      background: rgba(24, 42, 64, 0.65);
      color: inherit;
      font-size: 0.95rem;
      cursor: pointer;
      transition: transform 0.12s ease, background 0.12s ease, border 0.12s ease;
    }

    button.tool.active {
      background: rgba(90, 142, 255, 0.25);
      border-color: rgba(90, 142, 255, 0.9);
      box-shadow: 0 0 0 1px rgba(90, 142, 255, 0.6);
    }

    button.tool:hover {
      transform: translateY(-1px);
      background: rgba(40, 60, 90, 0.7);
    }

    .tool-icon {
      font-size: 1.15rem;
    }

    .map-wrapper {
      position: relative;
      display: grid;
      gap: 1rem;
    }

    #mapCanvas {
      width: min(80vw, 800px);
      height: min(80vw, 800px);
      aspect-ratio: 1 / 1;
      background: #0a1322;
      border-radius: 1.2rem;
      padding: 1rem;
      display: grid;
      place-items: center;
      box-shadow: 0 1.5rem 3rem rgba(0, 0, 0, 0.4);
    }

    #grid {
      display: grid;
      width: 100%;
      height: 100%;
      background: #053042;
      border-radius: 1rem;
      overflow: hidden;
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.05);
    }

    .tile {
      display: grid;
      place-items: center;
      font-size: 1.4rem;
      font-weight: 600;
      cursor: crosshair;
      transition: background 0.1s ease, transform 0.05s ease;
      user-select: none;
    }

    .tile:hover {
      filter: brightness(1.1);
      transform: scale(1.02);
    }

    .tile[data-base="sea"] {
      background: linear-gradient(135deg, #0f3057, #0b1f36);
      color: #9ecbff;
    }

    .tile[data-base="land"] {
      background: linear-gradient(135deg, #3a5f2b, #1f3317);
      color: #f1ffe2;
    }

    .tile[data-overlay="path"] {
      background: linear-gradient(135deg, #5b4d3b, #3c3226);
      color: #fbe4c1;
    }

    .tile[data-overlay="grass"] {
      background: linear-gradient(135deg, #4d8f3a, #2f6124);
    }

    .tile[data-overlay="house"] {
      background: linear-gradient(135deg, #5c1f2f, #35101b);
    }

    .tile[data-overlay="sign"] {
      background: linear-gradient(135deg, #8a5a24, #503014);
    }

    #status {
      min-height: 2.5rem;
      font-size: 0.95rem;
      line-height: 1.45;
      color: #cfe3ff;
    }

    .export-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
    }

    .primary {
      background: linear-gradient(135deg, #73a8ff, #5d7dff);
      color: #041021;
      border: none;
      font-weight: 600;
      padding: 0.75rem 1.2rem;
      border-radius: 0.85rem;
      cursor: pointer;
      box-shadow: 0 0.75rem 2rem rgba(94, 141, 255, 0.35);
      transition: transform 0.15s ease;
    }

    .primary:hover {
      transform: translateY(-1px) scale(1.01);
    }

    .secondary {
      border: 1px solid rgba(158, 203, 255, 0.4);
      background: rgba(24, 42, 64, 0.7);
      padding: 0.75rem 1.2rem;
      border-radius: 0.85rem;
      cursor: pointer;
      color: #f4f7fb;
    }

    .map-settings {
      display: grid;
      gap: 0.65rem;
    }

    label input {
      margin-left: 0.35rem;
      width: 4.5rem;
      padding: 0.3rem;
      border-radius: 0.4rem;
      border: 1px solid rgba(255, 255, 255, 0.15);
      background: rgba(7, 12, 20, 0.8);
      color: inherit;
    }

    @media (max-width: 1024px) {
      body {
        grid-template-columns: 1fr;
      }

      header {
        justify-content: center;
        text-align: center;
      }

      #mapCanvas {
        width: min(90vw, 640px);
        height: min(90vw, 640px);
        margin: 0 auto;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Town Level Designer</h1>
    <div>
      <span>Left click to paint • Right click to sea</span>
    </div>
  </header>

  <section class="controls" aria-label="Designer Controls">
    <fieldset>
      <legend>Palette</legend>
      <div class="tool-list" id="toolList"></div>
    </fieldset>

    <fieldset class="map-settings">
      <legend>Map Settings</legend>
      <label>Grid Size: <input type="number" id="gridSize" min="6" max="50" value="16" /></label>
      <button class="secondary" id="resizeGrid">Resize Grid</button>
    </fieldset>

    <div id="status" aria-live="polite"></div>

    <div class="export-buttons">
      <button class="primary" id="openLevel">Open Level Page</button>
      <button class="secondary" id="downloadJson">Download Layout JSON</button>
    </div>
  </section>

  <section class="map-wrapper">
    <div id="mapCanvas">
      <div id="grid" role="grid"></div>
    </div>
  </section>

  <template id="tileTemplate">
    <button class="tile" type="button"></button>
  </template>

  <script>
    const palette = [
      { id: 'land', label: 'Land', icon: '🏝️', description: 'Claim land from the surrounding sea.' },
      { id: 'sea', label: 'Sea', icon: '🌊', description: 'Return a tile to open water.' },
      { id: 'grass', label: 'Grass', icon: '🌿', description: 'Add grassy terrain on land tiles.' },
      { id: 'path', label: 'Path', icon: '🪨', description: 'Lay walking paths for players.' },
      { id: 'house', label: 'House', icon: '🏠', description: 'Place village houses on land.' },
      { id: 'sign', label: 'Sign', icon: '📜', description: 'Add signage for directions or lore.' }
    ];

    const overlayEmoji = {
      none: '',
      grass: '🌿',
      path: '🪨',
      house: '🏠',
      sign: '📜'
    };

    let currentTool = 'land';
    let gridSize = 16;
    let mouseDown = false;

    const gridElement = document.getElementById('grid');
    const statusElement = document.getElementById('status');

    const tileTemplate = document.getElementById('tileTemplate');

    const state = [];

    function initPalette() {
      const toolList = document.getElementById('toolList');
      palette.forEach(tool => {
        const button = document.createElement('button');
        button.type = 'button';
        button.className = 'tool';
        button.dataset.tool = tool.id;
        button.innerHTML = `<span class="tool-icon">${tool.icon}</span> ${tool.label}`;
        button.title = tool.description;
        if (tool.id === currentTool) button.classList.add('active');
        button.addEventListener('click', () => {
          currentTool = tool.id;
          document.querySelectorAll('.tool').forEach(btn => btn.classList.toggle('active', btn.dataset.tool === currentTool));
          updateStatus(`Selected ${tool.label}. ${tool.description}`);
        });
        toolList.appendChild(button);
      });
    }

    function createState(size) {
      state.length = 0;
      for (let y = 0; y < size; y++) {
        const row = [];
        for (let x = 0; x < size; x++) {
          row.push({ base: 'sea', overlay: 'none' });
        }
        state.push(row);
      }
    }

    function renderGrid() {
      gridElement.innerHTML = '';
      gridElement.style.gridTemplateColumns = `repeat(${gridSize}, 1fr)`;
      gridElement.style.gridTemplateRows = `repeat(${gridSize}, 1fr)`;

      for (let y = 0; y < gridSize; y++) {
        for (let x = 0; x < gridSize; x++) {
          const tileState = state[y][x];
          const tile = tileTemplate.content.firstElementChild.cloneNode(true);
          tile.dataset.x = x;
          tile.dataset.y = y;
          updateTileAppearance(tile, tileState);
          tile.addEventListener('pointerdown', handlePointerDown);
          tile.addEventListener('pointerenter', handlePointerEnter);
          tile.addEventListener('contextmenu', event => event.preventDefault());
          gridElement.appendChild(tile);
        }
      }
    }

    function updateTileAppearance(tile, tileState) {
      tile.dataset.base = tileState.base;
      tile.dataset.overlay = tileState.overlay;
      tile.textContent = overlayEmoji[tileState.overlay] || '';
      tile.setAttribute('aria-label', `${tileState.base} tile${tileState.overlay !== 'none' ? ' with ' + tileState.overlay : ''}`);
    }

    function applyTool(x, y, tool = currentTool) {
      const tile = state[y][x];
      switch (tool) {
        case 'sea':
          tile.base = 'sea';
          tile.overlay = 'none';
          break;
        case 'land':
          tile.base = 'land';
          tile.overlay = tile.overlay === 'none' ? 'none' : tile.overlay;
          break;
        case 'grass':
        case 'path':
        case 'house':
        case 'sign':
          if (tile.base !== 'land') {
            updateStatus('You need to claim land before placing terrain or buildings.');
            return false;
          }
          tile.overlay = tool;
          break;
      }
      return true;
    }

    function handlePointerDown(event) {
      event.preventDefault();
      const tool = event.button === 2 ? 'sea' : currentTool;
      const x = Number(event.currentTarget.dataset.x);
      const y = Number(event.currentTarget.dataset.y);
      mouseDown = true;
      if (applyTool(x, y, tool)) {
        updateTileAppearance(event.currentTarget, state[y][x]);
      }
      window.addEventListener('pointerup', handlePointerUp, { once: true });
    }

    function handlePointerEnter(event) {
      if (!mouseDown) return;
      const tool = event.buttons === 2 ? 'sea' : currentTool;
      const x = Number(event.currentTarget.dataset.x);
      const y = Number(event.currentTarget.dataset.y);
      if (applyTool(x, y, tool)) {
        updateTileAppearance(event.currentTarget, state[y][x]);
      }
    }

    function handlePointerUp() {
      mouseDown = false;
    }

    function updateStatus(message) {
      statusElement.textContent = message;
    }

    function resizeGrid() {
      const requested = Number(document.getElementById('gridSize').value);
      if (!Number.isInteger(requested) || requested < 6 || requested > 50) {
        updateStatus('Grid size must be between 6 and 50.');
        return;
      }
      gridSize = requested;
      createState(gridSize);
      renderGrid();
      updateStatus(`Grid resized to ${gridSize} × ${gridSize}. Start shaping your land!`);
    }

    function exportJson() {
      const layout = {
        size: gridSize,
        tiles: state
      };
      const blob = new Blob([JSON.stringify(layout, null, 2)], { type: 'application/json' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'town-layout.json';
      link.click();
      URL.revokeObjectURL(link.href);
    }

    function openLevelPage() {
      const levelHtml = generateLevelHtml();
      const levelWindow = window.open('', '_blank');
      if (!levelWindow) {
        updateStatus('Pop-up blocked. Allow pop-ups to open the level page.');
        return;
      }
      levelWindow.document.write(levelHtml);
      levelWindow.document.close();
    }

    function generateLevelHtml() {
      const tileSize = Math.floor(600 / gridSize);
      const mapRows = state
        .map((row, y) => {
          const cells = row
            .map((tile, x) => {
              const classes = [`base-${tile.base}`];
              if (tile.overlay !== 'none') classes.push(`overlay-${tile.overlay}`);
              const label = `${tile.base}${tile.overlay !== 'none' ? ' with ' + tile.overlay : ''}`;
              return `<div class="cell ${classes.join(' ')}" data-x="${x}" data-y="${y}" aria-label="${label}">${overlayEmoji[tile.overlay] || ''}</div>`;
            })
            .join('');
          return `<div class="row">${cells}</div>`;
        })
        .join('');

      return `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Town Level Preview</title>
  <style>
    :root { color-scheme: dark; }
    body {
      margin: 0;
      min-height: 100vh;
      display: grid;
      place-items: center;
      background: radial-gradient(circle at top, rgba(120, 180, 255, 0.18), rgba(9, 14, 24, 0.95));
      font-family: "Segoe UI", system-ui, sans-serif;
      color: #eef5ff;
    }
    h1 { margin-bottom: 1rem; letter-spacing: 0.08em; text-transform: uppercase; }
    .map {
      display: grid;
      grid-template-rows: repeat(${gridSize}, ${tileSize}px);
      grid-template-columns: repeat(${gridSize}, ${tileSize}px);
      background: #041422;
      padding: 0.75rem;
      border-radius: 1.2rem;
      box-shadow: 0 1.5rem 3.5rem rgba(0, 0, 0, 0.4);
      gap: 2px;
    }
    .cell {
      display: grid;
      place-items: center;
      font-size: ${Math.max(tileSize * 0.6, 12)}px;
      border-radius: 0.35rem;
    }
    .base-sea { background: linear-gradient(135deg, #0d3357, #051729); color: #8fbefc; }
    .base-land { background: linear-gradient(135deg, #375126, #1c2c15); color: #f1ffd8; }
    .base-land.overlay-path { background: linear-gradient(135deg, #5d4a39, #31261c); }
    .base-land.overlay-grass { background: linear-gradient(135deg, #4d8f3a, #2f6124); }
    .base-land.overlay-house { background: linear-gradient(135deg, #5c1f2f, #35101b); }
    .base-land.overlay-sign { background: linear-gradient(135deg, #8a5a24, #503014); }
    footer { margin-top: 1.5rem; font-size: 0.9rem; color: rgba(238, 245, 255, 0.7); }
  </style>
</head>
<body>
  <main>
    <h1>Town Level Preview</h1>
    <section class="map" role="grid" aria-label="Town layout">
      ${mapRows}
    </section>
    <footer>Everything beyond the island edge is open sea and currently inaccessible.</footer>
  </main>
</body>
</html>`;
    }

    document.getElementById('resizeGrid').addEventListener('click', resizeGrid);
    document.getElementById('downloadJson').addEventListener('click', exportJson);
    document.getElementById('openLevel').addEventListener('click', openLevelPage);
    gridElement.addEventListener('pointerleave', () => (mouseDown = false));

    initPalette();
    createState(gridSize);
    renderGrid();
    updateStatus('Select Land to shape your island, then place grass, paths, houses, and signs. Right-click turns tiles back into sea.');
  </script>
</body>
</html>
